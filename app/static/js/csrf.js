function getCsrfToken(){const tokenInput=document.querySelector('input[name="csrf_token"]');if(tokenInput){return tokenInput.value;}
const metaTag=document.querySelector('meta[name="csrf-token"]');if(metaTag){return metaTag.getAttribute('content');}
console.warn('[CSRF] CSRF token not found on page');return'';}
async function fetchWithCsrf(url,options={}){options.headers=options.headers||{};if(options.method&&options.method.toUpperCase()!=='GET'){const csrfToken=getCsrfToken();if(csrfToken){options.headers['x-csrf-token']=csrfToken;}else{console.error('[CSRF] Token not found - request may fail');}}
return fetch(url,options);}
function initMultipartFormHandling(){document.addEventListener('submit',async function(e){const form=e.target;if(!form||form.enctype!=='multipart/form-data'){return;}
e.preventDefault();const csrfToken=getCsrfToken();if(!csrfToken){console.error('[CSRF] Token not found for file upload form');alert('CSRF token not found. Please reload the page.');return;}
const formData=new FormData(form);let action=form.action||window.location.href;console.log('[CSRF] Original action:',action);console.log('[CSRF] window.location.origin:',window.location.origin);console.log('[CSRF] window.location.protocol:',window.location.protocol);if(action.startsWith(window.location.origin)){action=action.substring(window.location.origin.length);}
else if(window.location.protocol==='https:'&&action.startsWith('http://')){action=action.replace('http://','https://');}
console.log('[CSRF] Final action:',action);const method=form.method.toUpperCase()||'POST';const absoluteUrl=new URL(action,window.location.href);console.log('[CSRF] Absolute URL:',absoluteUrl.href);const xhr=new XMLHttpRequest();xhr.open(method,absoluteUrl.href);xhr.setRequestHeader('x-csrf-token',csrfToken);xhr.onload=function(){console.log('[CSRF] Response status:',xhr.status);console.log('[CSRF] Response URL:',xhr.responseURL);if(xhr.status>=200&&xhr.status<300){const finalUrl=xhr.responseURL;if(finalUrl&&finalUrl!==absoluteUrl.href){console.log('[CSRF] Redirecting to:',finalUrl);window.location.href=finalUrl;}else{console.log('[CSRF] Reloading page');window.location.reload();}}else{console.error('[CSRF] Form submission failed:',xhr.status,xhr.responseText.substring(0,200));alert('Ошибка при отправке формы: '+xhr.status);}};xhr.onerror=function(){console.error('[CSRF] Network error');alert('Ошибка сети при отправке формы');};xhr.send(formData);});}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initMultipartFormHandling);}else{initMultipartFormHandling();}
if(typeof module!=='undefined'&&module.exports){module.exports={getCsrfToken,fetchWithCsrf};}